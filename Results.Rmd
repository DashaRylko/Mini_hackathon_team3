---
title: "Results"
output: html_document
date: "2025-11-02"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggplot2)
library(flextable)

theme_custom <- theme(
    axis.text = element_text(size = 10),
    axis.title = element_text(size = 12),
    plot.title = element_text(size = 15, hjust = 0.5),
    plot.subtitle = element_text(size = 10, hjust = 0.5),
    legend.title = element_text(size = 10),
    legend.text = element_text(size = 8),
    panel.background = element_rect(fill = "white"), 
    panel.grid = element_blank()
  )

theme_set(theme_custom)
```

```{r}
data <- read.csv('data/CrohnD.csv')
```

## 1


```{r}

```

## 2

```{r}
library(patchwork)
```


```{r}
#Приведем типы данных
data_types <- data %>%
  select(-rownames) %>%
  mutate(across(c(country, sex, treat), as.factor),
         across(ID, as.character),
         across(c(nrAdvE, BMI, height, age, weight),as.numeric))

data_long <- data_types %>% 
  rename(
    "Количество НЯ" = nrAdvE,
    "Возраст" = age,
    "ИМТ" = BMI,
    "Рост" = height,
    "Вес" = weight
  ) %>% 
  pivot_longer(cols = where(is.numeric), names_to = "variable", values_to = "value")

```

# Анализ количественных переменных

```{r fig.width = 7, fig.height=4}
# Строим гистограммы
ggplot(data_long, aes(x = value, fill = variable)) +
  geom_histogram(bins = 30, alpha = 0.6, color = "black") +
  facet_wrap(~variable, scales = 'free') +
  labs(title = "Распределения количественных признаков",
       x = "Значение", y = "Частота", fill = "Количественная\nпеременная")
  
```
Из данных графиков видим, что признак количество НЯ распределен скошенным образом и дискретно

# Приведены графики для оценки средних и 95% ДИ для различных количественных признаков

```{r fig.width = 7, fig.height=4}
se <- function(x) {
  sd(x, na.rm = TRUE) / sqrt(length(x))
}

age_plot <- data_types %>%
  group_by(treat) %>%
  summarise(
    mean_age = mean(age),
    sd = sd(age),
    se = se(age),
    ci_95_min = mean_age - 1.96 * se,
    ci_95_max = mean_age + 1.96 * se
  ) %>%
  ggplot() +
  geom_point(aes(x = treat, y = mean_age, color = treat)) +
  geom_errorbar(aes(
    x = treat,
    y = mean_age,
    ymin = ci_95_min,
    ymax = ci_95_max, color = treat
  ), width = 0.5)+
     scale_color_brewer(palette = "Set2")+
  labs(x = "Тип лечения", y = "Среднее возраста",color = "Лечение")

BMI_plot <- data_types %>%
  group_by(treat) %>%
  summarise(
    mean_BMI = mean(BMI),
    sd = sd(BMI),
    se = se(BMI),
    ci_95_min = mean_BMI - 1.96 * se,
    ci_95_max = mean_BMI + 1.96 * se
  ) %>%
  ggplot() +
  geom_point(aes(x = treat, y = mean_BMI, color = treat)) +
  geom_errorbar(aes(
    x = treat,
    y = mean_BMI,
    ymin = ci_95_min,
    ymax = ci_95_max, color = treat
  ), width = 0.5)+
     scale_color_brewer(palette = "Set2")+
  labs(x = "Тип лечения", y = "Среднее ИМТ",color = "Лечение")

height_plot <- data_types %>%
  group_by(treat) %>%
  summarise(
    mean_height = mean(height),
    sd = sd(height),
    se = se(height),
    ci_95_min = mean_height - 1.96 * se,
    ci_95_max = mean_height + 1.96 * se
  ) %>%
  ggplot() +
  geom_point(aes(x = treat, y = mean_height, color = treat)) +
  geom_errorbar(aes(
    x = treat,
    y = mean_height,
    ymin = ci_95_min,
    ymax = ci_95_max, color = treat
  ), width = 0.5)+
     scale_color_brewer(palette = "Set2")+
  labs(x = "Тип лечения", y = "Среднее роста",color = "Лечение")

weight_plot <- data_types %>%
  group_by(treat) %>%
  summarise(
    mean_weight = mean(weight),
    sd = sd(weight),
    se = se(weight),
    ci_95_min = mean_weight - 1.96 * se,
    ci_95_max = mean_weight + 1.96 * se
  ) %>%
  ggplot() +
  geom_point(aes(x = treat, y = mean_weight, color = treat)) +
  geom_errorbar(aes(
    x = treat,
    y = mean_weight,
    ymin = ci_95_min,
    ymax = ci_95_max, color = treat
  ), width = 0.5)+
     scale_color_brewer(palette = "Set2")+
  labs(x = "Тип лечения", y = "Среднее веса",color = "Лечение")

res_plot <- (age_plot|BMI_plot) / (height_plot|weight_plot)

wrap_plots(res_plot) +
  plot_annotation(title = "95% интервалы распределения количественных переменных",
                  subtitle = "по группам лечения")
```
С помощью данного графика можем оценить различия в значениях количественных переменных по разным группам лечения.

# Анализ номинативных переменнных

```{r fig.width = 7, fig.height=4}
(ggplot(data_types, aes(x = treat,fill = treat)) +
  geom_bar(position = position_dodge(width = 0.8), width = 0.7, color = 'black') +
  labs(title = "Распределение по типу лечения",
       x = "Лечение", y = "Частота")+
  scale_fill_brewer(palette = "Set2"))/
((ggplot(data_types, aes(x = country, fill = treat)) +
  geom_bar(position = position_dodge(width = 0.8), width = 0.7, color = 'black')+
  labs(title = "Распределение по странам",
       x = "Страна", y = "Частота", fill = "Лечение")+
  scale_fill_brewer(palette = "Set2"))|  
(ggplot(data_types, aes(x = sex, fill = treat)) +
  geom_bar(position = position_dodge(width = 0.8), width = 0.7, color = 'black') +
  labs(title = "Распределение по полу",
       x = "Пол", y = "Частота", fill = "Лечение")+
  scale_fill_brewer(palette = "Set2")))


```
Из графиков видим, что группы распределены достаточно равномерно

# Анализ основного показателя (количество НЯ)

```{r fig.width = 8, fig.height=3}
(
  ggplot(data_types, aes(
    x = treat, y = nrAdvE, fill = treat
  )) +
    geom_boxplot(width = 0.5) +
    geom_jitter(width = 0.2) +
    theme_minimal() +
    labs(
      title = "Количество НЯ по типу лечения",
      x = "Тип лечения",
      y = "Количество НЯ",
      fill = "Лечение"
    ) +
    scale_fill_brewer(palette = "Set2")
)|
  (data_types %>%
     group_by(treat) %>%
     summarise(
       mean_nrAdvE = mean(nrAdvE),
       sd = sd(nrAdvE),
       se = se(nrAdvE),
       ci_95_min = mean_nrAdvE - 1.96 * se,
       ci_95_max = mean_nrAdvE + 1.96 * se
     ) %>%
     ggplot() +
     geom_point(aes(x = treat, y = mean_nrAdvE, color = treat)) +
     geom_errorbar(aes(
       x = treat,
       y = mean_nrAdvE,
       ymin = ci_95_min,
       ymax = ci_95_max,
       color = treat
     ), width = 0.5)+
     scale_color_brewer(palette = "Set2")+
     labs(title = "95% ДИ для среднего количества НЯ",
          x = "Тип лечения", y = "Среднее",color = "Лечение")+
     theme_minimal())
```
Из графика можно оценить распределение данной переменной. Также можем увидеть разницу в оценке среднего количества НЯ для разных групп лечения.

## 3

```{r}

```

## 4

```{r}

```

